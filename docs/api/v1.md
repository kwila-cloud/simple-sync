# simple-sync API Specification

This document describes the API endpoints for the `simple-sync` system.

## Authentication

All endpoints (except `/api/v1/auth/token` and `/api/v1/health`) require authentication via JSON Web Token (JWT) passed in the `Authorization` header. `/api/v1/auth/token` require authentication via username and password.

## Events

### `GET /api/v1/events`

*   **Purpose:** Retrieve the authoritative event history.
*   **Method:** GET
*   **Request:**
    *   (Optional) Query parameter `fromTimestamp`:  If provided, only events with a timestamp greater than or equal to this value will be returned.
*   **Response:**
    *   Success (200 OK): A JSON array of event objects.
    *   Unauthorized (401 Unauthorized):  If the user is not authenticated.
*   **Example Request:**

    ```
    GET /api/v1/events?fromTimestamp=1678886400
    Authorization: Bearer <JWT>
    ```

*   **Example Response:**

    ```json
    [
        {
            "uuid": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
            "timestamp": 1678886400,
            "userUuid": "user123",
            "itemUuid": "item456",
            "action": "create",
            "payload": "{}"
        },
        {
            "uuid": "b2c3d4e5-f6a7-8901-2345-67890abcdef0",
            "timestamp": 1678886401,
            "userUuid": "user123",
            "itemUuid": "item456",
            "action": "update",
            "payload": "{\"name\": \"New Name\"}"
        }
    ]
    ```

### `POST /api/v1/events`

*   **Purpose:** Push the client's diff history to the server.
*   **Method:** POST
*   **Request:**
    *   A JSON array of event objects representing the diff history.
*   **Response:**
    *   Success (200 OK): A JSON array of event objects representing the *new* authoritative event history (after the diff has been applied).
    *   Unauthorized (401 Unauthorized): If the user is not authenticated.
*   **Example Request:**

    ```
    POST /api/v1/events
    Authorization: Bearer <JWT>
    Content-Type: application/json

    [
        {
            "uuid": "c3d4e5f6-a7b8-9012-3456-7890abcdef01",
            "timestamp": 1678886402,
            "userUuid": "user123",
            "itemUuid": "item789",
            "action": "create",
            "payload": "{}"
        }
    ]
    ```

*   **Example Response:**

    ```json
    [
        {
            "uuid": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
            "timestamp": 1678886400,
            "userUuid": "user123",
            "itemUuid": "item456",
            "action": "create",
            "payload": "{}"
        },
        {
            "uuid": "b2c3d4e5-f6a7-8901-2345-67890abcdef0",
            "timestamp": 1678886401,
            "userUuid": "user123",
            "itemUuid": "item456",
            "action": "update",
            "payload": "{\"name\": \"New Name\"}"
        },
        {
            "uuid": "c3d4e5f6-a7b8-9012-3456-7890abcdef01",
            "timestamp": 1678886402,
            "userUuid": "user123",
            "itemUuid": "item789",
            "action": "create",
            "payload": "{}"
        }
    ]
    ```

## ACL

**Note:** ACL endpoints are not yet implemented in the current version.

### `GET /api/v1/acl`

*   **Purpose:** Retrieve the current ACL.
*   **Method:** GET
*   **Request:** None
*   **Response:**
    *   Success (200 OK): A JSON representation of the ACL.
    *   Unauthorized (401 Unauthorized): If the user is not authenticated or does not have permission to view the ACL.
*   **Example Request:**

    ```
    GET /api/v1/acl
    Authorization: Bearer <JWT>
    ```

*   **Example Response:**

    ```json
    {
      "rules": [
        {
          "user": "*",
          "item": "item123",
          "action": "view",
          "allow": true
        },
        {
          "user": "user456",
          "item": "*",
          "action": "edit",
          "allow": true
        },
        {
          "user": "*",
          "item": "*",
          "action": "*",
          "allow": false
        }
      ]
    }
    ```

### `PUT /api/v1/acl`

*   **Purpose:** Update the ACL.
*   **Method:** PUT
*   **Request:**
    *   A JSON representation of the new ACL.
*   **Response:**
    *   Success (204 No Content): If the update was successful.
    *   Unauthorized (401 Unauthorized): If the user is not authenticated or does not have permission to modify the ACL.
    *   Bad Request (400 Bad Request): If the provided ACL is invalid.
*   **Example Request:**

    ```
    PUT /api/v1/acl
    Authorization: Bearer <JWT>
    Content-Type: application/json

    {
      "rules": [
        {
          "user": "*",
          "item": "item123",
          "action": "view",
          "allow": true
        },
        {
          "user": "user456",
          "item": "*",
          "action": "edit",
          "allow": true
        },
        {
          "user": "*",
          "item": "*",
          "action": "*",
          "allow": false
        }
      ]
    }
    ```

*   **Example Response:**

    ```
    204 No Content
    ```

### ACL Access Control

Access to the `/api/v1/acl` endpoint is restricted to administrators. See [ACL Documentation](docs/acl.md) for more details on the ACL structure and syntax.

## Admin API

**Note:** Admin API endpoints are not yet implemented in the current version.

The following endpoints are part of the Admin API and are used for managing users. These endpoints use the same authentication mechanism as the regular user API. 

### `POST /api/v1/admin/users`

*   **Purpose:** Create a new user.
*   **Method:** POST
*   **Request:**
    *   A JSON object containing the new user's information: `uuid`, `username`, and `password`.
*   **Response:**
    *   Success (201 Created): The new user's UUID.
    *   Bad Request (400 Bad Request): If the request is invalid or the username already exists.
    *   Unauthorized (401 Unauthorized): If the user is not authenticated or does not have administrator privileges.
*   **Example Request:**

    ```
    POST /api/v1/admin/users
    Authorization: Bearer <JWT>
    Content-Type: application/json

    {
        "uuid": "newuser123",
        "username": "newuser",
        "password": "newpassword"
    }
    ```

*   **Example Response:**

    ```
    201 Created
    {
        "uuid": "newuser123"
    }
    ```

### `PUT /api/v1/admin/users/{uuid}`

*   **Purpose:** Update a user's username and/or password.
*   **Method:** PUT
*   **Request:**
    *   The user's UUID in the URL path.
    *   A JSON object containing the fields to update: `new_username` and/or `new_password`.
*   **Response:**
    *   Success (204 No Content): If the user was updated successfully.
    *   Not Found (404 Not Found): If the user with the specified UUID does not exist.
    *   Unauthorized (401 Unauthorized): If the user is not authenticated or does not have administrator privileges.
    *   Bad Request (400 Bad Request): If the new username already exists or the request is invalid.
*   **Example Request:**

    ```
    PUT /api/v1/admin/users/newuser123
    Authorization: Bearer <JWT>
    Content-Type: application/json

    {
        "new_username": "newusername",
        "new_password": "evenstrongerpassword"
    }
    ```

*   **Example Response:**

    ```
    204 No Content
    ```

### Admin Authentication

The Admin API uses the same authentication mechanism as the regular user API.

## Health Check

### `GET /api/v1/health`

*   **Purpose:** Check the health status of the service.
*   **Method:** GET
*   **Request:** None
*   **Response:**
    *   Success (200 OK): A JSON object containing the service health information.
*   **Example Request:**

    ```
    GET /api/v1/health
    ```

*   **Example Response:**

    ```json
    {
        "status": "healthy",
        "timestamp": "2025-09-22T08:14:09Z",
        "version": "0.1.0",
        "uptime": 123
    }
    ```

## Authentication

### `POST /api/v1/auth/token`

*   **Purpose:** Obtain an authentication token.
*   **Method:** POST
*   **Request:**
    *   A JSON object containing user credentials: `username` and `password`.
*   **Response:**
    *   Success (200 OK): A JSON object containing the authentication token. The token is a JSON Web Token (JWT) and is valid for one week.
    *   Unauthorized (401 Unauthorized): If the credentials are invalid.
*   **Example Request:**

    ```
    POST /api/v1/auth/token
    Content-Type: application/json

    {
        "username": "testuser",
        "password": "testpass123"
    }
    ```

*   **Example Response:**

    ```json
    {
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyMTIzIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjE1MTY5MzkwMjJ9.dQw4w9WgXcQxzAfaWEmBRjN7jV0RvKjLyWjZnQYjWj4"
    }
    ```


